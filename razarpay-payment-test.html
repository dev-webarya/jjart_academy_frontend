<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé® Art Academy - Payment Test</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 40px;
            max-width: 560px;
            width: 100%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
        }

        h1 {
            color: #1a1a2e;
            text-align: center;
            margin-bottom: 8px;
            font-size: 2rem;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 25px;
            font-size: 0.95rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .tab:hover {
            border-color: #ccc;
        }

        .tab.active {
            background: linear-gradient(135deg, #e94560 0%, #0f3460 100%);
            color: white;
            border-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #1a1a2e;
            font-size: 0.85rem;
        }

        input,
        textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafafa;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #e94560;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.1);
        }

        input::placeholder,
        textarea::placeholder {
            color: #aaa;
        }

        .row {
            display: flex;
            gap: 15px;
        }

        .row .form-group {
            flex: 1;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #e94560 0%, #0f3460 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(233, 69, 96, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            margin-top: 10px;
        }

        .status {
            margin-top: 18px;
            padding: 14px 18px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .status.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 1px solid #b1dfbb;
        }

        .status.error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 1px solid #f1b0b7;
        }

        .status.info {
            background: linear-gradient(135deg, #cce5ff 0%, #b8daff 100%);
            color: #004085;
            border: 1px solid #9fcdff;
        }

        .hidden {
            display: none;
        }

        .steps {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .step {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 6px 0;
        }

        .step-num {
            width: 28px;
            height: 28px;
            background: #e8e8e8;
            color: #888;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 14px;
            font-weight: bold;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .step span {
            color: #666;
            font-size: 0.9rem;
        }

        .step.done .step-num {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .step.done span {
            color: #28a745;
            font-weight: 500;
        }

        .step.active .step-num {
            background: linear-gradient(135deg, #e94560 0%, #0f3460 100%);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .step.active span {
            color: #1a1a2e;
            font-weight: 500;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        pre {
            background: #1a1a2e;
            color: #e8e8e8;
            padding: 16px;
            border-radius: 10px;
            overflow-x: auto;
            font-size: 11px;
            margin-top: 18px;
            font-family: 'Consolas', monospace;
            line-height: 1.4;
            max-height: 200px;
        }

        .help-text {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üé® Art Academy Payment</h1>
        <p class="subtitle">Razorpay Integration Test</p>

        <!-- Mode Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('full')">üîÑ Full Flow</div>
            <div class="tab" onclick="switchTab('direct')">‚ö° Direct Checkout</div>
        </div>

        <!-- Common Config -->
        <div class="form-group">
            <label>API Base URL</label>
            <input type="text" id="apiUrl" value="http://localhost:8095">
        </div>
        <div class="form-group">
            <label>JWT Token (Customer)</label>
            <input type="text" id="token" placeholder="eyJhbGciOiJIUzUxMiJ9...">
        </div>

        <!-- Tab 1: Full Flow -->
        <div id="tab-full" class="tab-content active">
            <div class="form-group">
                <label>Order ID (MongoDB ObjectId)</label>
                <input type="text" id="orderId" placeholder="e.g., 678a1234567890abcdef1234">
            </div>
            <button id="payBtn" onclick="initiatePayment()">üí≥ Initiate & Pay</button>
        </div>

        <!-- Tab 2: Direct Checkout -->
        <div id="tab-direct" class="tab-content">
            <div class="form-group">
                <label>Paste Initiate Response JSON (or fill fields below)</label>
                <textarea id="jsonInput"
                    placeholder='{"razorpayOrderId": "order_xxx", "razorpayKeyId": "rzp_test_xxx", "amount": 235, ...}'></textarea>
                <button class="btn-secondary" onclick="parseJson()">üìã Parse JSON</button>
            </div>

            <div class="row">
                <div class="form-group">
                    <label>Razorpay Order ID *</label>
                    <input type="text" id="razorpayOrderId" placeholder="order_S51spa35ZGZaJ9">
                </div>
                <div class="form-group">
                    <label>Razorpay Key ID *</label>
                    <input type="text" id="razorpayKeyId" placeholder="rzp_test_RlZy2hUEUVQyxy">
                </div>
            </div>
            <div class="row">
                <div class="form-group">
                    <label>Amount (‚Çπ)</label>
                    <input type="number" id="amount" placeholder="235" value="235">
                </div>
                <div class="form-group">
                    <label>Currency</label>
                    <input type="text" id="currency" value="INR">
                </div>
            </div>
            <div class="form-group">
                <label>Order Number (optional)</label>
                <input type="text" id="orderNumber" placeholder="ORD-2026-001">
            </div>
            <button onclick="directCheckout()">üí≥ Open Razorpay Checkout</button>
        </div>

        <div id="status" class="status hidden"></div>

        <div class="steps">
            <div class="step" id="step1">
                <div class="step-num">1</div><span>Initiate Payment</span>
            </div>
            <div class="step" id="step2">
                <div class="step-num">2</div><span>Razorpay Checkout</span>
            </div>
            <div class="step" id="step3">
                <div class="step-num">3</div><span>Verify Payment</span>
            </div>
        </div>

        <pre id="response" class="hidden"></pre>
    </div>

    <script>
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab:nth-child(${tab === 'full' ? 1 : 2})`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            resetSteps();
        }

        function parseJson() {
            try {
                const json = JSON.parse(document.getElementById('jsonInput').value);
                if (json.razorpayOrderId) document.getElementById('razorpayOrderId').value = json.razorpayOrderId;
                if (json.razorpayKeyId) document.getElementById('razorpayKeyId').value = json.razorpayKeyId;
                if (json.amount) document.getElementById('amount').value = json.amount;
                if (json.currency) document.getElementById('currency').value = json.currency;
                if (json.orderNumber) document.getElementById('orderNumber').value = json.orderNumber;
                showStatus('‚úÖ JSON parsed successfully!', 'success');
            } catch (e) {
                showStatus('‚ùå Invalid JSON format', 'error');
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function setStep(step, state) {
            document.getElementById(`step${step}`).className = `step ${state}`;
        }

        function resetSteps() {
            for (let i = 1; i <= 3; i++) document.getElementById(`step${i}`).className = 'step';
            document.getElementById('status').className = 'status hidden';
        }

        function showResponse(data) {
            const pre = document.getElementById('response');
            pre.textContent = JSON.stringify(data, null, 2);
            pre.className = 'pre';
        }

        function openRazorpay(config, token, apiUrl) {
            const options = {
                key: config.keyId,
                amount: config.amount * 100,
                currency: config.currency || 'INR',
                name: 'Art Academy',
                description: config.orderNumber ? `Order: ${config.orderNumber}` : 'Art Academy Order',
                image: 'https://cdn-icons-png.flaticon.com/512/3050/3050337.png',
                order_id: config.razorpayOrderId,
                theme: { color: '#e94560' },
                handler: async function (response) {
                    setStep(2, 'done');
                    setStep(3, 'active');
                    showStatus('üîÑ Verifying payment...', 'info');

                    try {
                        const verifyUrl = new URL(`${apiUrl}/api/v1/art-payments/verify`);
                        verifyUrl.searchParams.append('razorpayOrderId', response.razorpay_order_id);
                        verifyUrl.searchParams.append('razorpayPaymentId', response.razorpay_payment_id);
                        verifyUrl.searchParams.append('razorpaySignature', response.razorpay_signature);

                        const verifyResponse = await fetch(verifyUrl.toString(), {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                        });

                        const verifyData = await verifyResponse.json();
                        showResponse(verifyData);

                        if (verifyResponse.ok) {
                            setStep(3, 'done');
                            showStatus(`‚úÖ Payment successful! Status: ${verifyData.status}`, 'success');
                        } else {
                            throw new Error(verifyData.message || 'Verification failed');
                        }
                    } catch (err) {
                        showStatus(`‚ùå Verification failed: ${err.message}`, 'error');
                    }
                },
                modal: {
                    ondismiss: function () { showStatus('‚ö†Ô∏è Payment cancelled', 'error'); }
                }
            };

            const rzp = new Razorpay(options);
            rzp.on('payment.failed', function (resp) {
                showStatus(`‚ùå Payment failed: ${resp.error.description}`, 'error');
                showResponse(resp.error);
            });
            rzp.open();
        }

        // Full Flow
        async function initiatePayment() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const token = document.getElementById('token').value.trim();
            const orderId = document.getElementById('orderId').value.trim();

            if (!token || !orderId) {
                showStatus('‚ö†Ô∏è Please enter JWT token and Order ID!', 'error');
                return;
            }

            resetSteps();
            setStep(1, 'active');
            showStatus('üîÑ Initiating payment...', 'info');

            try {
                const resp = await fetch(`${apiUrl}/api/v1/art-payments/initiate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId })
                });

                if (!resp.ok) throw new Error(`Initiate failed: ${resp.status}`);

                const data = await resp.json();
                showResponse(data);
                setStep(1, 'done');
                setStep(2, 'active');
                showStatus('üîÑ Opening Razorpay...', 'info');

                openRazorpay({ keyId: data.razorpayKeyId, razorpayOrderId: data.razorpayOrderId, amount: data.amount, currency: data.currency, orderNumber: data.orderNumber }, token, apiUrl);
            } catch (err) {
                showStatus(`‚ùå ${err.message}`, 'error');
            }
        }

        // Direct Checkout
        function directCheckout() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const token = document.getElementById('token').value.trim();
            const razorpayOrderId = document.getElementById('razorpayOrderId').value.trim();
            const razorpayKeyId = document.getElementById('razorpayKeyId').value.trim();
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const currency = document.getElementById('currency').value.trim() || 'INR';
            const orderNumber = document.getElementById('orderNumber').value.trim();

            if (!token || !razorpayOrderId || !razorpayKeyId) {
                showStatus('‚ö†Ô∏è Please enter Token, Razorpay Order ID, and Key ID!', 'error');
                return;
            }

            resetSteps();
            setStep(1, 'done'); // Already done via Swagger
            setStep(2, 'active');
            showStatus('üîÑ Opening Razorpay checkout...', 'info');

            openRazorpay({ keyId: razorpayKeyId, razorpayOrderId, amount, currency, orderNumber }, token, apiUrl);
        }
    </script>
</body>

</html>